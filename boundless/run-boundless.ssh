#!/bin/bash

set -e

echo "=== Boundless Prover Runner ==="

cd boundless || { echo "❌ Run setup script first!"; exit 1; }

# Step 1: Load Sepolia environment variables
echo ">>> Loading Sepolia environment..."
if [ -f .env.eth-sepolia ]; then
  source .env.eth-sepolia
else
  echo "⚠️  .env.eth-sepolia file not found, skipping..."
fi

# Step 2: Load ALL variables from .env.broker
if [ -f .env.broker ]; then
  echo ">>> Loading .env.broker..."
  set -a
  source .env.broker
  set +a
else
  echo "❌ .env.broker file not found!"
  exit 1
fi

echo "✅ Wallet and RPC configured"
echo "→ Wallet: ${PRIVATE_KEY:0:6}... (truncated)"
echo "→ RPC: $RPC_URL"
echo "→ Verifier: $VERIFIER_ADDRESS"

# Step 3: Optional stake deposit
read -p "Do you want to deposit stake now? (yes/no): " CONFIRM
if [ "$CONFIRM" == "yes" ]; then
    read -p "Enter USDC amount to stake: " AMOUNT
    boundless account deposit-stake "$AMOUNT"
else
    echo ">>> Skipping stake deposit."
fi

# Step 4: Start broker
echo "🚀 Starting Boundless broker with your environment..."
just broker up ./.env.broker

echo ""
echo "✅ Broker running!"
echo "👉 Monitor logs: just broker logs"
echo "👉 Stop broker: just broker down"
echo "👉 Clean data: just broker clean"
